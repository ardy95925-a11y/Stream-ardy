<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Pulse â€” Sign in</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { display:flex;align-items:center;justify-content:center;min-height:100dvh;background:var(--bg-base); }
    .bg-orb { position:fixed;border-radius:50%;filter:blur(120px);pointer-events:none;z-index:0; }
    .bg-orb-1 { width:600px;height:600px;top:-200px;right:-100px;background:radial-gradient(circle,rgba(255,107,53,0.18) 0%,transparent 70%);animation:orbDrift 8s ease-in-out infinite alternate; }
    .bg-orb-2 { width:400px;height:400px;bottom:-150px;left:-80px;background:radial-gradient(circle,rgba(255,190,11,0.1) 0%,transparent 70%);animation:orbDrift 11s ease-in-out infinite alternate-reverse; }
    @keyframes orbDrift { from{transform:translate(0,0) scale(1)} to{transform:translate(40px,30px) scale(1.08)} }
    .login-card { position:relative;z-index:1;width:min(440px,90vw);background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-xl);padding:48px 40px;box-shadow:var(--shadow-deep);animation:cardIn 0.7s cubic-bezier(0.34,1.2,0.64,1) forwards; }
    @keyframes cardIn { from{opacity:0;transform:translateY(32px) scale(0.95)} to{opacity:1;transform:translateY(0) scale(1)} }
    .logo { display:flex;align-items:center;gap:12px;margin-bottom:40px; }
    .logo-icon { width:48px;height:48px;background:var(--accent);border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px var(--accent-glow); }
    .logo-icon svg { width:26px;height:26px;color:#fff; }
    .logo-text { font-family:'Syne',sans-serif;font-size:26px;font-weight:800;letter-spacing:-0.5px; }
    .logo-text span { color:var(--accent); }
    .login-headline { font-family:'Syne',sans-serif;font-size:28px;font-weight:800;line-height:1.2;margin-bottom:8px;letter-spacing:-0.5px; }
    .login-sub { font-size:14px;color:var(--text-secondary);margin-bottom:28px;line-height:1.6; }
    .features { display:flex;flex-wrap:wrap;gap:8px;margin-bottom:28px; }
    .feature-pill { padding:5px 12px;background:var(--accent-soft);border:1px solid var(--border-accent);border-radius:var(--radius-pill);font-size:12px;color:var(--accent);font-weight:500; }
    .btn-google { width:100%;padding:14px 20px;background:#fff;border:none;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;gap:12px;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:500;color:#1f1f1f;cursor:pointer;transition:var(--transition);box-shadow:0 2px 12px rgba(0,0,0,0.3); }
    .btn-google:hover { transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.4); }
    .btn-google:active { transform:scale(0.97); }
    .btn-google:disabled { opacity:0.7;cursor:not-allowed;transform:none; }
    .btn-google img { width:20px;height:20px; }
    .spinner { width:20px;height:20px;border:2px solid rgba(0,0,0,0.15);border-top-color:#1f1f1f;border-radius:50%;animation:spin 0.7s linear infinite;flex-shrink:0; }
    @keyframes spin { to{transform:rotate(360deg)} }
    .privacy-note { margin-top:20px;font-size:12px;color:var(--text-muted);text-align:center;line-height:1.6; }
    .error-box { display:none;margin-top:16px;padding:12px 16px;background:rgba(255,71,87,0.1);border:1px solid rgba(255,71,87,0.3);border-radius:var(--radius-md);font-size:13px;color:#ff6070;line-height:1.5;word-break:break-all; }
    .error-box.visible { display:block; }
    .status-text { margin-top:12px;font-size:12px;color:var(--text-muted);text-align:center; }
  </style>
</head>
<body>
  <div class="bg-orb bg-orb-1"></div>
  <div class="bg-orb bg-orb-2"></div>
  <div class="login-card">
    <div class="logo">
      <div class="logo-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      </div>
      <div class="logo-text">Pul<span>se</span></div>
    </div>
    <div class="login-headline">Messaging,<br>reimagined.</div>
    <p class="login-sub">Real-time chat that's fast, beautiful, and actually enjoyable to use.</p>
    <div class="features">
      <span class="feature-pill">âš¡ Instant delivery</span>
      <span class="feature-pill">ðŸ”’ Private chats</span>
      <span class="feature-pill">ðŸŽ¨ Beautiful UI</span>
      <span class="feature-pill">ðŸ‘¥ Friend system</span>
    </div>
    <button class="btn-google" id="googleSignInBtn">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
      Continue with Google
    </button>
    <div class="error-box" id="errorBox"></div>
    <div class="status-text" id="statusText"></div>
    <p class="privacy-note">Your data stays yours. No ads, ever.</p>
  </div>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect,
      getRedirectResult, onAuthStateChanged, setPersistence, browserLocalPersistence
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCPabeR73HulqHs-wAq_ass1lUxkoEijAY",
      authDomain: "chatin-e7d51.firebaseapp.com",
      projectId: "chatin-e7d51",
      storageBucket: "chatin-e7d51.firebasestorage.app",
      messagingSenderId: "175440428513",
      appId: "1:175440428513:web:c6b365aa7728f0ad5a66a0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });

    // FIX 1: Explicitly set LOCAL persistence so login survives browser restarts
    await setPersistence(auth, browserLocalPersistence);

    const btn = document.getElementById('googleSignInBtn');
    const errorBox = document.getElementById('errorBox');
    const statusText = document.getElementById('statusText');

    function showError(msg) { errorBox.textContent = msg; errorBox.classList.add('visible'); statusText.textContent = ''; }
    function showStatus(msg) { statusText.textContent = msg; errorBox.classList.remove('visible'); }
    function setLoading(loading) {
      btn.disabled = loading;
      btn.innerHTML = loading
        ? '<div class="spinner"></div> Signing inâ€¦'
        : '<img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google"> Continue with Google';
    }

    async function goToApp(user) {
      showStatus('Signed in! Loading appâ€¦');
      setLoading(true);
      try { await getDoc(doc(db, 'users', user.uid)); } catch(e) {}
      window.location.href = 'app.html';
    }

    // FIX 2: Handle redirect result first
    try {
      showStatus('Checking sign-in statusâ€¦');
      const result = await getRedirectResult(auth);
      if (result?.user) { await goToApp(result.user); } else { showStatus(''); }
    } catch(e) {
      if (e.code !== 'auth/no-auth-event' && e.code !== 'auth/null-user') {
        showError('Redirect error: ' + e.code + ' â€” ' + e.message);
      } else { showStatus(''); }
    }

    // FIX 3: If already logged in (persistent session), skip login page entirely
    onAuthStateChanged(auth, async user => {
      if (user) { await goToApp(user); }
    });

    btn.addEventListener('click', async () => {
      setLoading(true);
      errorBox.classList.remove('visible');
      try {
        const result = await signInWithPopup(auth, provider);
        await goToApp(result.user);
      } catch(popupError) {
        const useRedirect = ['auth/popup-blocked','auth/popup-closed-by-user','auth/cancelled-popup-request','auth/operation-not-supported-in-this-environment','auth/web-storage-unsupported'].includes(popupError.code);
        if (useRedirect) {
          try { showStatus('Opening Google sign-inâ€¦'); await signInWithRedirect(auth, provider); }
          catch(e) { showError('Error: ' + e.code + '\n' + e.message); setLoading(false); }
        } else {
          showError('Sign-in error: ' + popupError.code + '\n\n' + popupError.message);
          setLoading(false);
        }
      }
    });
  </script>
</body>
</html>
