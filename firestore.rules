// ═══════════════════════════════════════════════════════════
// PULSE2 — firestore.rules
//
// IMPORTANT: Paste these rules into your Firebase Console
// → Firestore Database → Rules tab → Publish
//
// Without these rules the app will show "permission denied"
// and messages won't load or send.
// ═══════════════════════════════════════════════════════════

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper functions ──────────────────────────────────
    function isLoggedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return request.auth.uid == uid;
    }

    // ── Users ─────────────────────────────────────────────
    // Anyone logged in can read all user profiles
    // Only the owner can write their own profile
    match /users/{userId} {
      allow read:  if isLoggedIn();
      allow write: if isLoggedIn() && isOwner(userId);
    }

    // ── Channels ──────────────────────────────────────────
    // Public channels: read by all logged-in users
    // Create: any logged-in user
    // Update/Delete: creator only
    match /channels/{channelId} {
      allow read:   if isLoggedIn();
      allow create: if isLoggedIn();
      allow update, delete: if isLoggedIn() &&
        resource.data.createdBy == request.auth.uid;

      // Messages in channels
      match /messages/{messageId} {
        allow read:   if isLoggedIn();
        allow create: if isLoggedIn() &&
          request.resource.data.authorId == request.auth.uid;
        // Only author can edit/delete their own messages
        allow update: if isLoggedIn() &&
          resource.data.authorId == request.auth.uid;
        allow delete: if isLoggedIn() &&
          resource.data.authorId == request.auth.uid;
      }

      // Typing indicators
      match /typing/{userId} {
        allow read, write: if isLoggedIn() && isOwner(userId);
      }
    }

    // ── Direct Messages ────────────────────────────────────
    // DM rooms: only members can access
    match /dms/{dmId} {
      allow read:   if isLoggedIn() &&
        request.auth.uid in resource.data.members;
      allow create: if isLoggedIn() &&
        request.auth.uid in request.resource.data.members;
      allow update: if isLoggedIn() &&
        request.auth.uid in resource.data.members;

      // Messages inside DM
      match /messages/{messageId} {
        allow read:   if isLoggedIn() &&
          request.auth.uid in get(/databases/$(database)/documents/dms/$(dmId)).data.members;
        allow create: if isLoggedIn() &&
          request.resource.data.authorId == request.auth.uid &&
          request.auth.uid in get(/databases/$(database)/documents/dms/$(dmId)).data.members;
        allow update: if isLoggedIn() &&
          resource.data.authorId == request.auth.uid;
        allow delete: if isLoggedIn() &&
          resource.data.authorId == request.auth.uid;
      }

      // Typing in DM
      match /typing/{userId} {
        allow read, write: if isLoggedIn() && isOwner(userId);
      }
    }
  }
}
